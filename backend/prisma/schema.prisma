// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
}

enum CampaignContactStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum EventType {
  EMAIL_SENT
  EMAIL_OPENED
  LINK_CLICKED
  EMAIL_BOUNCED
  EMAIL_FAILED
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String?
  role         Role       @default(EDITOR)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  campaigns    Campaign[]

  @@map("users")
}

model Contact {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String?
  company      String?
  phone        String?
  tags         String[]  @default([])
  customFields Json?     @map("custom_fields")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  campaignContacts  CampaignContact[]
  events            Event[]
  contactListMembers ContactListMember[]
  sequenceEnrollments SequenceEnrollment[]

  @@index([email])
  @@index([tags])
  @@map("contacts")
}

model ContactList {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  members ContactListMember[]

  @@map("contact_lists")
}

model ContactListMember {
  id            String   @id @default(uuid())
  contactListId String   @map("contact_list_id")
  contactId     String   @map("contact_id")
  addedAt       DateTime @default(now()) @map("added_at")

  contactList ContactList @relation(fields: [contactListId], references: [id], onDelete: Cascade)
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactListId, contactId])
  @@index([contactListId])
  @@index([contactId])
  @@map("contact_list_members")
}

model Campaign {
  id           String         @id @default(uuid())
  name         String
  subject      String
  preheader    String?
  htmlContent  String         @map("html_content") @db.Text
  fromEmail    String         @map("from_email")
  fromName     String         @map("from_name")
  status       CampaignStatus @default(DRAFT)
  scheduledAt  DateTime?      @map("scheduled_at")
  sentAt       DateTime?      @map("sent_at")
  createdById  String         @map("created_by_id")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  createdBy        User              @relation(fields: [createdById], references: [id])
  campaignContacts CampaignContact[]
  events           Event[]

  @@index([status])
  @@index([createdById])
  @@index([scheduledAt])
  @@map("campaigns")
}

model CampaignContact {
  id         String                @id @default(uuid())
  campaignId String                @map("campaign_id")
  contactId  String                @map("contact_id")
  status     CampaignContactStatus @default(PENDING)
  trackToken String                @unique @default(uuid()) @map("track_token")
  sentAt     DateTime?             @map("sent_at")
  createdAt  DateTime              @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([trackToken])
  @@map("campaign_contacts")
}

model Event {
  id                       String    @id @default(uuid())
  type                     EventType
  campaignId               String?   @map("campaign_id")
  contactId                String    @map("contact_id")
  sequenceId               String?   @map("sequence_id")
  sequenceStepExecutionId  String?   @map("sequence_step_execution_id")
  metadata                 Json?
  ip                       String?
  userAgent                String?   @map("user_agent") @db.Text
  country                  String?
  city                     String?
  device                   String?
  createdAt                DateTime  @default(now()) @map("created_at")

  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  sequence Sequence? @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  sequenceStepExecution SequenceStepExecution? @relation(fields: [sequenceStepExecutionId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([contactId])
  @@index([sequenceId])
  @@index([sequenceStepExecutionId])
  @@index([type])
  @@index([createdAt])
  @@map("events")
}

model Template {
  id          String   @id @default(uuid())
  name        String
  htmlContent String   @map("html_content") @db.Text
  thumbnail   String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("templates")
}

enum SequenceStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum SequenceTriggerType {
  MANUAL
  CONTACT_CREATED
  LIST_ADDED
  TAG_ADDED
  EMAIL_OPENED
  LINK_CLICKED
}

enum SequenceStepStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

enum SchedulingType {
  RELATIVE_DELAY
  ABSOLUTE_DATE
}

model Sequence {
  id          String         @id @default(uuid())
  name        String
  description String?
  status      SequenceStatus @default(ACTIVE)
  triggerType SequenceTriggerType @map("trigger_type")
  triggerValue String?       @map("trigger_value")
  fromEmail   String         @map("from_email")
  fromName    String         @map("from_name")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  steps       SequenceStep[]
  enrollments SequenceEnrollment[]
  events      Event[]

  @@map("sequences")
}

model SequenceStep {
  id                    String         @id @default(uuid())
  sequenceId            String         @map("sequence_id")
  stepOrder             Int            @map("step_order")
  name                  String
  subject               String
  htmlContent           String         @map("html_content") @db.Text
  schedulingType        SchedulingType @default(RELATIVE_DELAY) @map("scheduling_type")
  delayDays             Int            @default(0) @map("delay_days")
  delayHours            Int            @default(0) @map("delay_hours")
  absoluteScheduleDate  DateTime?      @map("absolute_schedule_date")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  sequence     Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  executions   SequenceStepExecution[]

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
  @@map("sequence_steps")
}

model SequenceEnrollment {
  id         String   @id @default(uuid())
  sequenceId String   @map("sequence_id")
  contactId  String   @map("contact_id")
  status     SequenceStatus @default(ACTIVE)
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")
  pausedAt   DateTime? @map("paused_at")

  sequence   Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  executions SequenceStepExecution[]

  @@unique([sequenceId, contactId])
  @@index([sequenceId])
  @@index([contactId])
  @@index([status])
  @@map("sequence_enrollments")
}

model SequenceStepExecution {
  id           String             @id @default(uuid())
  enrollmentId String             @map("enrollment_id")
  stepId       String             @map("step_id")
  status       SequenceStepStatus @default(PENDING)
  scheduledFor DateTime           @map("scheduled_for")
  sentAt       DateTime?          @map("sent_at")
  trackToken   String             @unique @default(uuid()) @map("track_token")
  error        String?            @db.Text
  createdAt    DateTime           @default(now()) @map("created_at")

  enrollment SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step       SequenceStep       @relation(fields: [stepId], references: [id], onDelete: Cascade)
  events     Event[]

  @@unique([enrollmentId, stepId])
  @@index([enrollmentId])
  @@index([stepId])
  @@index([status])
  @@index([scheduledFor])
  @@map("sequence_step_executions")
}
